<!doctype html>
<html>
    <head>
        <title>canvas</title>
        <meta charset='utf-8' />
    </head>
    <body>
        <canvas height='421' width='841' id='playground'>Обновите браузер</canvas>
        <script>
            var h_amount = 20, w_amount = 40, size = 20, border = 1;
            // количество клеток по вертикали, горизонтали, размер клетки, толщина границы
            var canvas_width = border + (border + size) * w_amount, canvas_height = border + (border + size) * h_amount;
            // размеры поля
            var field = new Array(w_amount);
            for (var i = 0; i < w_amount; i++) {
                field[i] = new Array(h_amount);
            }

            // спрайты змейки
            var body = new Image();
            body.src = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQIAHAAcAAD//gATQ3JlYXRlZCB3aXRoIEdJTVD/2wBDAAQDAwQDAwQEAwQFBAQFBgoHBgYGBg0JCggKDw0QEA8NDw4RExgUERIXEg4PFRwVFxkZGxsbEBQdHx0aHxgaGxr/2wBDAQQFBQYFBgwHBwwaEQ8RGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhoaGhr/wAARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAcGCP/EACMQAAICAgICAgMBAAAAAAAAAAIDAQQFBgAHERITIRQXIlH/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8A6OJX7D7qz2vbfs12pU1O3jcrhtVrq/EDIKBQsHIObMfJaWNs5CAWQrA6i/kEpKPNY2rZKuo67kc1kFuemmqTGvWGCfZZM+q0JGZj3aw5FYB58kZiMfcxyP8Aa2yVcH3h1jY3VeM1vU8Wq/cq7RfGPV2QZXaicb80zA1RlJk+SZPhxJAR/oJ5sO3qFX10rP5msm3htY2VOTyENXBwlc17FYbP9fyIobZVYNhSMLWljPPkIiQy+b6XzvZmUfsW0dhdgaUdn1Gngddzy6iaNeBiBBsgBC15F7mZwRQMn8YkYrEycuHHAm/e9dmR6zv4ddt1FOeyGMwltyICWRVu369WxAe4kMFKXsiJmJ8TPmPuI5QL9CrlKNmjk6ybtG0o02K71wxbllEwQGM+YIZiZiYn6mJ444E/6fpL12ptOm48nHhtSzcY3FfkPN7QqnTq2xUTDmZIVzbJQf4paxnzMSROOOB//9k=";

            for (var i = 0; i < w_amount; i++)
                for (var j = 0; j < h_amount; j++)
                    field[i][j] = 0;

            var canvas = document.getElementById("playground"),
                context = canvas.getContext('2d');

            function recolor_image(image, red, green, blue) { // возвращает перекрашенную картинку. Рисуется на канвас с помощью putImageData(img, x, y)
            	var temp_canvas = document.createElement('canvas');
				var temp_context = temp_canvas.getContext('2d');
				temp_context.drawImage(image, 0, 0);
				var imageData = temp_context.getImageData(0, 0, image.width, image.height);
                delete temp_context;
                delete temp_canvas;
                
                var color_barrier = 50;  // все цвета от 0 до color_barrier будут перекрашиваться

                for(var i = 0; i < image.width * image.height * 4; i += 4) {
                    if(imageData.data[i] <= color_barrier && imageData.data[i+1] <= color_barrier && imageData.data[i+2] <= color_barrier) {
                        imageData.data[i] += red;
                        imageData.data[i+1] += green;
                        imageData.data[i+2] += blue;
                        // imageData.data[i+3]  <-- альфа-канал
                    }
                }
                return imageData;
            }

            // функция, закрашивающая клетку поля с координатами (x, y) 
            // в цвет color с рамкой размера margin
            function fill_square(x, y, type, color) {
                var margin = 0, rotation = type % 4;
                context.save();
                switch (rotation) {
                    case 0:
                        context.translate(x * (border + size) + border + margin, y * (border + size) + border + margin);
                        break;
                    case 1:
                        context.translate(x * (border + size) + border + margin + size, y * (border + size) + border + margin);
                        break;
                    case 2:
                        context.translate(x * (border + size) + border + margin + size, y * (border + size) + border + margin + size);
                        break;
                    case 3:
                        context.translate(x * (border + size) + border + margin, y * (border + size) + border + margin + size);
                        break;
                }
                context.rotate(Math.PI/2 * rotation);
                var temp_canvas = document.createElement('canvas');
				var temp_context = temp_canvas.getContext('2d');
				// TODO: выделение из color переменных red, green, blue
				temp_context.putImageData(recolor_image(body, 250, 0, 0), 0, 0);
				// перекрашенный спрайт помещается на временный canvas, после чего оттуда печатается на основной
				context.drawImage(temp_canvas, 0, 0);
                context.restore();
                delete temp_context;
                delete temp_canvas;
            }

            // функция закрашивает левый или правый progress bar поединка в цвет color
            // на процент, равный progress
            function fill_progress_bar(x, y, width, height, progress, color, left) {
                var current_style = context.fillStyle, border = 2;
                context.fillStyle = color;
                if (left == false)
                    context.fillRect(x + border + (width - 2 * border) * (1 - progress), 
                        y + border, (width - 2 * border) * progress, height - 2 * border);
                else
                    context.fillRect(x + border, 
                        y + border, (width - 2 * border) * progress, height - 2 * border);
                context.fillStyle = current_style;
            }

            // отсчитывает time секунд с выводом на экран, после чего вызывает next_func
            function timer(time, next_func) {
                var i = time;
                context.clearRect(0, 0, canvas_width, canvas_height);
                context.textBaseline = "middle";
                context.textAlign = "center";
                context.font = 'bold 50px sans-serif';
                var timerId = setTimeout(function go() {
                    if (i > 0) {
                        context.clearRect(0, 0, canvas_width, canvas_height);
                        context.fillText(i, canvas_width / 2, canvas_height / 2);
                        setTimeout(go, 1000);
                    }
                    else {
                        clearTimeout(timerId);
                        next_func();
                    }
                    i--;
                }, 1000);
            }

            // разделяет поле на клетки
            function display_field() {
                for (var i = 0; i < canvas_height; i += border + size) {
                    context.fillRect(0, i, canvas_width, border);
                }
                for (var i = 0; i < canvas_width; i += border + size) {
                    context.fillRect(i, 0, border, canvas_height);
                }
            }

            function battleground() {
                context.clearRect(0, 0, canvas_width, canvas_height);

                display_field()

                // обновить field данными из websocket

                fill_square(1, 5, 7, "orange");

                //for (var i = 0; i < w_amount; i++)
                  //  for (var j = 0; j < h_amount; j++)
                    //        fill_square(i, j, field[i][j] + 1, "red");
            }

            function duel() {
                context.clearRect(0, 0, canvas_width, canvas_height);
                
                var separator = 50, margin = 10, bar_width = (canvas_width - separator - 2 * margin) / 2;
                // расстояние между bar'ами, отступ между bar'ом и краем, ширина bar'a
                var left_progress, right_progress;
                // эти значения каким-то образом получаются через websocket
                context.strokeRect(margin, margin, bar_width, 50);
                // левый progress bar
                context.strokeRect(canvas_width - bar_width - margin, margin, bar_width, 50);
                // правый progress bar

                // тестирование progress bar'ов
                left_progress = 1/2;
                right_progress = 2/3;
                fill_progress_bar(margin, margin, bar_width, 50, left_progress, "red", true);
                fill_progress_bar(canvas_width - bar_width - margin, margin, bar_width, 50, right_progress, "blue", false);
            }
            
            timer(3, battleground);

        </script>
    </body>
</html>
