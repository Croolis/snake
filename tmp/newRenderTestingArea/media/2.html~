
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Transformation test</title>
		<style type="text/css">
html {
	background : white;
	color      : black;
}
input[type=text] {
	border : none;
	border-bottom : 1px dashed #999;
	font : 15px monospace;
	margin : 2px;
	width : 4em;
	text-align : right;
}
canvas {
	border : 1px dashed #393;
	margin : 4px;
}
		</style>
	</head>
	<body>
		<code>context.translate(
		<input type="text" id="x" title="x" value="120" />,
		<input type="text" id="y" title="y" value="120" />);</code> <br />
		<code>context.rotate((<input type="text" id="degree" title="degree" value="30" />).degree());</code> <br />
		<code>context.drawImage(img, 
		<input type="text" id="ix" title="image x" value="-25" />,
		<input type="text" id="iy" title="image y" value="-25" />
		);</code> <br />
		<input type="submit" id="redraw" value="redraw" /> <br />
		<canvas id="canvas" width="640" height="400" />
	</body>
	<script type="text/javascript">

(function (undefined) {
	var $ = function (id) {
		return document.getElementById(id);
	};
	var drawCells = function (ctx, size) {
		size = size || 100;
		var canv = ctx.canvas;
		var w = ctx.canvas.width, h = ctx.canvas.height;
		var count = Math.ceil(Math.max(w, h) / size);
		ctx.save();
		ctx.beginPath();
		do {
			var line = count * size;
			ctx.moveTo(line, 0);
			ctx.lineTo(line, h);
			ctx.moveTo(0, line);
			ctx.lineTo(w, line);
		} while (count--);
		ctx.closePath();
		ctx.lineWidth = 0.3;
		ctx.strokeStyle = '#090';
		ctx.stroke();
		ctx.restore();
	};
    var rec = function (image, red, green, blue) {
        var ctx = $('canvas').getContext('2d');
        var tmpImage = ctx.getImageData(0, 0, image.width, image.height);
        ctx.drawImage(image, 0, 0);
        var imageData = ctx.getImageData(0, 0, image.width, image.height);
        ctx.putImageData(tmpImage, 0, 0); // восстановление канваса

        var color_barrier = 50;  // все цвета от 0 до color_barrier будут перекрашиваться

        for(var i = 0; i < image.width * image.height * 4; i += 4) {
            if(imageData.data[i] <= color_barrier && imageData.data[i+1] <= color_barrier && imageData.data[i+2] <= color_barrier) {
                imageData.data[i] += red;
                imageData.data[i+1] += green;
                imageData.data[i+2] += blue;
                // imageData.data[i+3]  <-- альфа-канал
            }
        }

        return imageData;
    }
	var draw = function (x, y) {
		var ctx = $('canvas').getContext('2d');
		ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
		drawCells(ctx, 80);
//        ctx.putImageData(rec(img, 0, 200, 0), 0, 0);
		ctx.save();
		ctx.translate($('x').value, $('y').value);
		//ctx.rotate(Number($('degree').value) * Math.PI / 180);
//		ctx.drawImage(img, $('ix').value, $('iy').value);
        var data = rec(img, 0, 200, 0);
        ctx.putImageData(data, $('ix').value, $('iy').value);
		ctx.restore();
	};
	var img = new Image;
	img.src = 'transform.png';
	img.onload = function () { draw() };
	$('redraw').onclick = draw;
})();
	</script>
</html>

